!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t||self).moonsong={})}(this,function(t){var e=1/3,n=function(t,e){var n=t?15:50;return e>n?1:e/n},a=function(t){var e=this;this.data=void 0,this.view=void 0,this.position=void 0,this.next=function(t,n){return function(){var a=t(e.position);return e.position+=n,a}},this.skip=function(t){return e.position+=t},this.nextByte=this.next(function(t){return e.view.getUint8(t)},1),this.nextSignedByte=this.next(function(t){return e.view.getInt8(t)},1),this.nextShort=this.next(function(t){return e.view.getUint16(t,!0)},2),this.nextSignedShort=this.next(function(t){return e.view.getInt16(t,!0)},2),this.nextBigEndianSignedShort=this.next(function(t){return e.view.getInt16(t,!1)},2),this.nextInt=this.next(function(t){return e.view.getInt32(t,!0)},4),this.nextWavetable=function(){for(var t=[],n=0;n<256;n++)t.push(e.nextSignedByte());return t},this.asDrumSample=function(){for(var t=[];e.position<e.data.length;)t.push(e.nextBigEndianSignedShort());return t},this.data=t,this.view=new DataView(t.buffer),this.position=0},s=function(t){return t>1?1:t<-1?-1:t},o=function(t){return new a(t).asDrumSample().map(function(t){return 1*t/32767})},r=[262,277,294,311,330,349,370,392,415,440,466,494],i=[32,64,64,128,128,128,128,128],l=[256,256,128,128,64,32,16,8],h=[0,43,86,129,172,215,256,297,340,383,426,469,512],u=function(t){var e=Math.floor(Math.min(12,Math.max(0,t))),n=10*(h[e]-256),a=1,s=1;return n<0?s=Math.pow(10,n/2e3):t>0&&(a=Math.pow(10,-n/2e3)),[a,s]},f=function(t,e){var n=this;this._sampleRate=void 0,this._wavetable=void 0,this._drums=void 0,this.useAlgorithmicPitch=!0,this.parseChannelData=function(t){return{voice:t.nextSignedShort(),instrument:t.nextByte(),pi:0!=t.nextByte(),noteCount:t.nextShort(),notes:[],loopNote:0}},this.parse=function(t){var e=new a(t),s=n._drums.map(function(t){return t.length});e.skip(6);var o,h,f=(o=e.nextShort(),h=n._sampleRate,function(t){return t*(Math.floor(h/1e3)*o)}),p=f(1);e.skip(2);for(var v=f(e.nextInt()),m=f(e.nextInt()),d=[],c=0;c<16;c++)d.push(n.parseChannelData(e));for(var g=0;g<16;g++){for(var x=95,w=1,y=254,S=6,M=0;M<d[g].noteCount;M++){var B=e.nextInt();d[g].notes.push({start:Math.floor(f(B)),end:0,leftVolume:0,rightVolume:0,pan:0,pitch:0,sampleAdvance:0,volume:0,length:0})}for(var b=0;b<d[g].noteCount;b++){var I=e.nextByte();255==I&&(I=x),x=I,d[g].notes[b].pitch=I}for(var _=0;_<d[g].noteCount;_++){var C=e.nextByte();255==C&&(C=w),w=C,d[g].notes[_].end=d[g].notes[_].start+f(C),d[g].notes[_].length=C}for(var A=0;A<d[g].noteCount;A++){var P=e.nextByte();255==P&&(P=y),y=P,d[g].notes[A].volume=P}for(var R=0;R<d[g].noteCount;R++){var D=e.nextByte();255==D&&(D=S),S=D,d[g].notes[R].pan=D}for(var V=0;V<d[g].noteCount;V++){var O=d[g].notes[V],k=O.pitch,E=g>=8,N=0;if(n.useAlgorithmicPitch)N=Math.pow(2,(k+d[g].voice/1e3+155.376)/12);else{var U=Math.floor(k%12),W=Math.floor(k/12);N=r[U]*i[W]+(d[g].voice-1e3)}var F=N/n._sampleRate,T=u(O.pan),j=T[0],q=T[1],z=Math.pow(10,8*(O.volume-255)/2e3);if(O.leftVolume=j*z,O.rightVolume=q*z,O.sampleAdvance=F,E){O.sampleAdvance=(800*O.pitch+100)/n._sampleRate,O.end=Math.floor(O.start+Math.min(s[d[g].instrument]/O.sampleAdvance,p*O.length/O.sampleAdvance));var G=d[g].notes[V+1];G&&(O.end=Math.floor(Math.min(O.end,G.start-1)))}if(d[g].pi){var H=Math.floor(k/12);O.end=O.start+4*(H+1)*l[H]}}d[g].notes.sort(function(t,e){return t.start-e.start});for(var J=0;J<d[g].noteCount;J++){var K=d[g].notes.findIndex(function(t){return t.end>v});d[g].loopNote=-1!=K?K:0}}return{startSamples:v,endSamples:m,channels:d,sampleRate:n._sampleRate,drums:n._drums,wavetable:n._wavetable}},this._sampleRate=t,this._wavetable=function(t){for(var e=[],n=new a(t),s=0;s<100;s++){var o=n.nextWavetable();e.push(o.map(function(t){return 1*t/256}))}return e}(e.WAVE100),this._drums=e.DRUMS.map(o)};t.OrganyaPlayer=function(t,a,o){var r=this;this.waveData=void 0,this.sampleRate=void 0,this.song=void 0,this.stepBuffer=[0,0],this.channelBuffer=[0,0],this.sample=void 0,this.state=void 0,this.run=function(t,e,n){for(var a=[new Float32Array(t),new Float32Array(t)],s=0;s<t;s++)r.step(r.stepBuffer),e[s]=r.stepBuffer[0],n[s]=r.stepBuffer[1];return a},this.step=function(t){for(var n=0,a=0,o=0;o<16;o++)r.stepChannel(o,r.channelBuffer),n+=r.channelBuffer[0]*e,a+=r.channelBuffer[1]*e;if(r.sample++,r.sample>=r.song.endSamples){for(var i=0;i<16;i++)r.state[i]={noteIndex:r.song.channels[i].loopNote,wavetableOffset:0,samplesPlayed:0};r.sample=r.song.startSamples}var l,h=(l=r.sample)>1e3?1:l/1e3;t[0]=s(n)*h,t[1]=s(a)*h},this.stepChannel=function(t,e){var a=r.song.channels[t],s=r.state[t].noteIndex,o=t>=8,i=s>=a.notes.length?null:a.notes[s],l=0,h=0;if(null!=i&&r.sample>i.start){var u=a.instrument;if(!a.pi||r.state[t].samplesPlayed<1024){var f=r.state[t].wavetableOffset+i.sampleAdvance,p=r.getSample(o?r.song.drums[u]:r.song.wavetable[u],f);l=p*i.leftVolume,h=p*i.rightVolume,r.state[t].wavetableOffset=f,r.state[t].samplesPlayed++;var v=n(o,r.state[t].samplesPlayed)*function(t,e,a){return n(t,a-e)}(o,r.state[t].samplesPlayed,i.end-i.start);l*=v,h*=v}}null!=i&&r.sample>=i.end&&(r.state[t].wavetableOffset=0,r.state[t].samplesPlayed=0,r.state[t].noteIndex++),e[0]=l,e[1]=h},this.getSample=function(t,e){var n=t[Math.floor(e)%t.length],a=t[Math.ceil(e)%t.length];return n+(e-Math.floor(e))*(a-n)},this.waveData=a,this.sampleRate=o;var i=new f(o,a);this.song=i.parse(t),this.sample=-4e3,this.state=[];for(var l=0;l<16;l++)this.state.push({noteIndex:0,wavetableOffset:0,samplesPlayed:0})}});
//# sourceMappingURL=org-player.umd.js.map
