!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t||self).moonsong={})}(this,function(t){var e=1/3,n=function(t,e){var n=t?15:50;return e>n?1:1-Math.pow(1-e/n,2)},r=function(t){var e=this;this.data=void 0,this.view=void 0,this.position=void 0,this.next=function(t,n){return function(){var r=t(e.position);return e.position+=n,r}},this.skip=function(t){return e.position+=t},this.nextByte=this.next(function(t){return e.view.getUint8(t)},1),this.nextSignedByte=this.next(function(t){return e.view.getInt8(t)},1),this.nextShort=this.next(function(t){return e.view.getUint16(t,!0)},2),this.nextSignedShort=this.next(function(t){return e.view.getInt16(t,!0)},2),this.nextBigEndianSignedShort=this.next(function(t){return e.view.getInt16(t,!1)},2),this.nextInt=this.next(function(t){return e.view.getInt32(t,!0)},4),this.nextWavetable=function(){for(var t=[],n=0;n<256;n++)t.push(e.nextSignedByte());return t},this.asDrumSample=function(){for(var t=[];e.position<e.data.length;)t.push(e.nextBigEndianSignedShort());return t},this.data=t,this.view=new DataView(t.buffer),this.position=0},a=function(t){return t>1?1:t<-1?-1:t},o=function(t){return new r(t).asDrumSample().map(function(t){return 1*t/32767})},s=[262,277,294,311,330,349,370,392,415,440,466,494],i=[32,64,64,128,128,128,128,128],u=[256,256,128,128,64,32,16,8],l=[0,43,86,129,172,215,256,297,340,383,426,469,512],h=function(t){var e=Math.floor(Math.min(12,Math.max(0,t))),n=10*(l[e]-256),r=1,a=1;return n<0?a=Math.pow(10,n/2e3):t>0&&(r=Math.pow(10,-n/2e3)),[r,a]},f=function(t,e){var n=this;this._sampleRate=void 0,this._wavetable=void 0,this._drums=void 0,this.useAlgorithmicPitch=!0,this.parseChannelData=function(t){return{voice:t.nextSignedShort(),instrument:t.nextByte(),pi:0!=t.nextByte(),noteCount:t.nextShort(),notes:[],loopNote:0}},this.parse=function(t){var e=new r(t),a=n._drums.map(function(t){return t.length});e.skip(6);var o,l,f=(o=e.nextShort(),l=n._sampleRate,function(t){return t*(Math.floor(l/1e3)*o)}),v=f(1);e.skip(2);for(var p=f(e.nextInt()),m=f(e.nextInt()),d=[],c=0;c<16;c++)d.push(n.parseChannelData(e));for(var g=0;g<16;g++){for(var x=95,w=1,P=254,y=6,S=0;S<d[g].noteCount;S++){var M=e.nextInt();d[g].notes.push({start:Math.floor(f(M)),end:0,leftVolume:0,rightVolume:0,pan:0,pitch:0,sampleAdvance:0,volume:0,length:0})}for(var B=0;B<d[g].noteCount;B++){var b=e.nextByte();255==b&&(b=x),x=b,d[g].notes[B].pitch=b}for(var A=0;A<d[g].noteCount;A++){var I=e.nextByte();255==I&&(I=w),w=I,d[g].notes[A].end=d[g].notes[A].start+f(I),d[g].notes[A].length=I}for(var _=0;_<d[g].noteCount;_++){var C=e.nextByte();255==C&&(C=P),P=C,d[g].notes[_].volume=C}for(var R=0;R<d[g].noteCount;R++){var D=e.nextByte();255==D&&(D=y),y=D,d[g].notes[R].pan=D}for(var V=0;V<d[g].noteCount;V++){var O=d[g].notes[V],W=O.pitch,E=g>=8,U=0;if(n.useAlgorithmicPitch)U=Math.pow(2,(W+d[g].voice/1e3+155.376)/12);else{var j=Math.floor(W%12),k=Math.floor(W/12);U=s[j]*i[k]+(d[g].voice-1e3)}var N=U/n._sampleRate,F=h(O.pan),T=F[0],q=F[1],z=Math.pow(10,8*(O.volume-255)/2e3);if(O.leftVolume=T*z,O.rightVolume=q*z,O.sampleAdvance=N,E){O.sampleAdvance=(800*O.pitch+100)/n._sampleRate,O.end=Math.floor(O.start+Math.min(a[d[g].instrument]/O.sampleAdvance,v*O.length/O.sampleAdvance));var G=d[g].notes[V+1];G&&(O.end=Math.floor(Math.min(O.end,G.start-1)))}if(d[g].pi){var H=Math.floor(W/12);O.end=O.start+4*(H+1)*u[H]}}d[g].notes.sort(function(t,e){return t.start-e.start});for(var J=0;J<d[g].noteCount;J++){var K=d[g].notes.findIndex(function(t){return t.end>p});d[g].loopNote=-1!=K?K:0}}return{startSamples:p,endSamples:m,channels:d,sampleRate:n._sampleRate,drums:n._drums,wavetable:n._wavetable,samplesPerBeat:f(1)}},this._sampleRate=t,this._wavetable=function(t){for(var e=[],n=new r(t),a=0;a<100;a++){var o=n.nextWavetable();e.push(o.map(function(t){return 1*t/256}))}return e}(e.WAVE100),this._drums=e.DRUMS.map(o)},v=function(t){try{return Promise.resolve(fetch(t)).then(function(t){return Promise.resolve(t.body.getReader().read()).then(function(t){return t.value})})}catch(t){return Promise.reject(t)}};t.OrganyaPlayer=function(t,r,o){var s=this;this.waveData=void 0,this.sampleRate=void 0,this.song=void 0,this.stepBuffer=[0,0],this.channelBuffer=[0,0],this.sample=void 0,this.state=void 0,this.run=function(t,e,n){for(var r=[new Float32Array(t),new Float32Array(t)],a=0;a<t;a++)s.step(s.stepBuffer),e[a]=s.stepBuffer[0],n[a]=s.stepBuffer[1];return r},this.step=function(t){for(var n=0,r=0,o=0;o<16;o++)s.stepChannel(o,s.channelBuffer),n+=s.channelBuffer[0]*e,r+=s.channelBuffer[1]*e;if(s.sample++,s.sample>=s.song.endSamples){for(var i=0;i<16;i++)s.state[i]={noteIndex:s.song.channels[i].loopNote,wavetableOffset:0,samplesPlayed:0};s.sample=s.song.startSamples}var u,l=(u=s.sample)>1e3?1:u/1e3;t[0]=a(n)*l,t[1]=a(r)*l},this.stepChannel=function(t,e){var r=s.song.channels[t],a=s.state[t].noteIndex,o=t>=8,i=a>=r.notes.length?null:r.notes[a],u=0,l=0;if(null!=i&&s.sample>i.start){var h=r.instrument;if(!r.pi||s.state[t].samplesPlayed<1024){var f=s.state[t].wavetableOffset+i.sampleAdvance,v=s.getSample(o?s.song.drums[h]:s.song.wavetable[h],f);u=v*i.leftVolume,l=v*i.rightVolume,s.state[t].wavetableOffset=f,s.state[t].samplesPlayed++;var p=n(o,s.state[t].samplesPlayed)*function(t,e,r){return n(t,r-e)}(o,s.state[t].samplesPlayed,i.end-i.start)*(o?1:s.state[t].samplesPlayed>s.song.samplesPerBeat?.5:1);u*=p,l*=p}}null!=i&&s.sample>=i.end&&(s.state[t].wavetableOffset=0,s.state[t].samplesPlayed=0,s.state[t].noteIndex++),e[0]=u,e[1]=l},this.getSample=function(t,e){var n=t[Math.floor(e)%t.length],r=t[Math.ceil(e)%t.length];return n+(e-Math.floor(e))*(r-n)},this.waveData=r,this.sampleRate=o;var i=new f(o,r);this.song=i.parse(t),this.sample=-4e3,this.state=[];for(var u=0;u<16;u++)this.state.push({noteIndex:0,wavetableOffset:0,samplesPlayed:0})},t.loadWavetableAndDrums=function(t){try{var e=t.endsWith("/")?"":"/",n=function(n){return t+e+n};return Promise.resolve(v(n("wave100.dat"))).then(function(t){return Promise.resolve(v(n("100.dat"))).then(function(e){return Promise.resolve(v(n("101.dat"))).then(function(r){return Promise.resolve(v(n("102.dat"))).then(function(a){return Promise.resolve(v(n("103.dat"))).then(function(o){return Promise.resolve(v(n("104.dat"))).then(function(s){return Promise.resolve(v(n("105.dat"))).then(function(i){return Promise.resolve(v(n("106.dat"))).then(function(u){return Promise.resolve(v(n("107.dat"))).then(function(l){return Promise.resolve(v(n("108.dat"))).then(function(h){return Promise.resolve(v(n("109.dat"))).then(function(f){return Promise.resolve(v(n("110.dat"))).then(function(p){return Promise.resolve(v(n("111.dat"))).then(function(n){return{WAVE100:t,DRUMS:[e,r,a,o,s,i,u,l,h,f,p,n]}})})})})})})})})})})})})})}catch(t){return Promise.reject(t)}}});
//# sourceMappingURL=org-player.umd.js.map
