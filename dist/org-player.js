var t=function(t,e){var n=t?15:50;return e>n?1:e/n},e=function(t){var e=this;this.data=void 0,this.view=void 0,this.position=void 0,this.next=function(t,n){return function(){var a=t(e.position);return e.position+=n,a}},this.skip=function(t){return e.position+=t},this.nextByte=this.next(function(t){return e.view.getUint8(t)},1),this.nextSignedByte=this.next(function(t){return e.view.getInt8(t)},1),this.nextShort=this.next(function(t){return e.view.getUint16(t,!0)},2),this.nextSignedShort=this.next(function(t){return e.view.getInt16(t,!0)},2),this.nextBigEndianSignedShort=this.next(function(t){return e.view.getInt16(t,!1)},2),this.nextInt=this.next(function(t){return e.view.getInt32(t,!0)},4),this.nextWavetable=function(){for(var t=[],n=0;n<256;n++)t.push(e.nextSignedByte());return t},this.asDrumSample=function(){for(var t=[];e.position<e.data.length;)t.push(e.nextBigEndianSignedShort());return t},this.data=t,this.view=new DataView(t.buffer),this.position=0},n=function(t){return t>1?1:t<-1?-1:t},a=function(t){return new e(t).asDrumSample().map(function(t){return 1*t/32767})},s=[262,277,294,311,330,349,370,392,415,440,466,494],r=[32,64,64,128,128,128,128,128],o=[256,256,128,128,64,32,16,8],i=[0,43,86,129,172,215,256,297,340,383,426,469,512],l=function(t){var e=Math.floor(Math.min(12,Math.max(0,t))),n=10*(i[e]-256),a=1,s=1;return n<0?s=Math.pow(10,n/2e3):t>0&&(a=Math.pow(10,-n/2e3)),[a,s]},h=function(t,n){var i=this;this._sampleRate=void 0,this._wavetable=void 0,this._drums=void 0,this.useAlgorithmicPitch=!0,this.parseChannelData=function(t){return{voice:t.nextSignedShort(),instrument:t.nextByte(),pi:0!=t.nextByte(),noteCount:t.nextShort(),notes:[],loopNote:0}},this.parse=function(t){var n=new e(t),a=i._drums.map(function(t){return t.length});n.skip(6);var h,u,f=(h=n.nextShort(),u=i._sampleRate,function(t){return t*(Math.floor(u/1e3)*h)}),v=f(1);n.skip(2);for(var p=f(n.nextInt()),m=f(n.nextInt()),d=[],c=0;c<16;c++)d.push(i.parseChannelData(n));for(var g=0;g<16;g++){for(var x=95,w=1,S=254,y=6,M=0;M<d[g].noteCount;M++){var B=n.nextInt();d[g].notes.push({start:Math.floor(f(B)),end:0,leftVolume:0,rightVolume:0,pan:0,pitch:0,sampleAdvance:0,volume:0,length:0})}for(var b=0;b<d[g].noteCount;b++){var I=n.nextByte();255==I&&(I=x),x=I,d[g].notes[b].pitch=I}for(var _=0;_<d[g].noteCount;_++){var C=n.nextByte();255==C&&(C=w),w=C,d[g].notes[_].end=d[g].notes[_].start+f(C),d[g].notes[_].length=C}for(var A=0;A<d[g].noteCount;A++){var P=n.nextByte();255==P&&(P=S),S=P,d[g].notes[A].volume=P}for(var R=0;R<d[g].noteCount;R++){var D=n.nextByte();255==D&&(D=y),y=D,d[g].notes[R].pan=D}for(var V=0;V<d[g].noteCount;V++){var O=d[g].notes[V],k=O.pitch,E=g>=8,N=0;if(i.useAlgorithmicPitch)N=Math.pow(2,(k+d[g].voice/1e3+155.376)/12);else{var U=Math.floor(k%12),W=Math.floor(k/12);N=s[U]*r[W]+(d[g].voice-1e3)}var F=N/i._sampleRate,j=l(O.pan),q=j[0],z=j[1],G=Math.pow(10,8*(O.volume-255)/2e3);if(O.leftVolume=q*G,O.rightVolume=z*G,O.sampleAdvance=F,E){O.sampleAdvance=(800*O.pitch+100)/i._sampleRate,O.end=Math.floor(O.start+Math.min(a[d[g].instrument]/O.sampleAdvance,v*O.length/O.sampleAdvance));var H=d[g].notes[V+1];H&&(O.end=Math.floor(Math.min(O.end,H.start-1)))}if(d[g].pi){var J=Math.floor(k/12);O.end=O.start+4*(J+1)*o[J]}}d[g].notes.sort(function(t,e){return t.start-e.start});for(var K=0;K<d[g].noteCount;K++){var L=d[g].notes.findIndex(function(t){return t.end>p});d[g].loopNote=-1!=L?L:0}}return{startSamples:p,endSamples:m,channels:d,sampleRate:i._sampleRate,drums:i._drums,wavetable:i._wavetable}},this._sampleRate=t,this._wavetable=function(t){for(var n=[],a=new e(t),s=0;s<100;s++){var r=a.nextWavetable();n.push(r.map(function(t){return 1*t/256}))}return n}(n.WAVE100),this._drums=n.DRUMS.map(a)};exports.OrganyaPlayer=function(e,a,s){var r=this;this.waveData=void 0,this.sampleRate=void 0,this.song=void 0,this.stepBuffer=[0,0],this.channelBuffer=[0,0],this.sample=void 0,this.state=void 0,this.run=function(t,e,n){for(var a=[new Float32Array(t),new Float32Array(t)],s=0;s<t;s++)r.step(r.stepBuffer),e[s]=r.stepBuffer[0],n[s]=r.stepBuffer[1];return a},this.step=function(t){for(var e=0,a=0,s=0;s<16;s++)r.stepChannel(s,r.channelBuffer),e+=.3333333333333333*r.channelBuffer[0],a+=.3333333333333333*r.channelBuffer[1];if(r.sample++,r.sample>=r.song.endSamples){for(var o=0;o<16;o++)r.state[o]={noteIndex:r.song.channels[o].loopNote,wavetableOffset:0,samplesPlayed:0};r.sample=r.song.startSamples}var i,l=(i=r.sample)>1e3?1:i/1e3;t[0]=n(e)*l,t[1]=n(a)*l},this.stepChannel=function(e,n){var a=r.song.channels[e],s=r.state[e].noteIndex,o=e>=8,i=s>=a.notes.length?null:a.notes[s],l=0,h=0;if(null!=i&&r.sample>i.start){var u=a.instrument;if(!a.pi||r.state[e].samplesPlayed<1024){var f=r.state[e].wavetableOffset+i.sampleAdvance,v=r.getSample(o?r.song.drums[u]:r.song.wavetable[u],f);l=v*i.leftVolume,h=v*i.rightVolume,r.state[e].wavetableOffset=f,r.state[e].samplesPlayed++;var p=t(o,r.state[e].samplesPlayed)*function(e,n,a){return t(e,a-n)}(o,r.state[e].samplesPlayed,i.end-i.start);l*=p,h*=p}}null!=i&&r.sample>=i.end&&(r.state[e].wavetableOffset=0,r.state[e].samplesPlayed=0,r.state[e].noteIndex++),n[0]=l,n[1]=h},this.getSample=function(t,e){var n=t[Math.floor(e)%t.length],a=t[Math.ceil(e)%t.length];return n+(e-Math.floor(e))*(a-n)},this.waveData=a,this.sampleRate=s;var o=new h(s,a);this.song=o.parse(e),this.sample=-4e3,this.state=[];for(var i=0;i<16;i++)this.state.push({noteIndex:0,wavetableOffset:0,samplesPlayed:0})};
//# sourceMappingURL=org-player.js.map
