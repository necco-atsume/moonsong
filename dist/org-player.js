var t=function(t,e){var n=t?15:50;return e>n?1:1-Math.pow(1-e/n,2)},e=function(t){var e=this;this.data=void 0,this.view=void 0,this.position=void 0,this.next=function(t,n){return function(){var r=t(e.position);return e.position+=n,r}},this.skip=function(t){return e.position+=t},this.nextByte=this.next(function(t){return e.view.getUint8(t)},1),this.nextSignedByte=this.next(function(t){return e.view.getInt8(t)},1),this.nextShort=this.next(function(t){return e.view.getUint16(t,!0)},2),this.nextSignedShort=this.next(function(t){return e.view.getInt16(t,!0)},2),this.nextBigEndianSignedShort=this.next(function(t){return e.view.getInt16(t,!1)},2),this.nextInt=this.next(function(t){return e.view.getInt32(t,!0)},4),this.nextWavetable=function(){for(var t=[],n=0;n<256;n++)t.push(e.nextSignedByte());return t},this.asDrumSample=function(){for(var t=[];e.position<e.data.length;)t.push(e.nextBigEndianSignedShort());return t},this.data=t,this.view=new DataView(t.buffer),this.position=0},n=function(t){return t>1?1:t<-1?-1:t},r=function(t){return new e(t).asDrumSample().map(function(t){return 1*t/32767})},a=[262,277,294,311,330,349,370,392,415,440,466,494],s=[32,64,64,128,128,128,128,128],o=[256,256,128,128,64,32,16,8],i=[0,43,86,129,172,215,256,297,340,383,426,469,512],u=function(t){var e=Math.floor(Math.min(12,Math.max(0,t))),n=10*(i[e]-256),r=1,a=1;return n<0?a=Math.pow(10,n/2e3):t>0&&(r=Math.pow(10,-n/2e3)),[r,a]},l=function(t,n){var i=this;this._sampleRate=void 0,this._wavetable=void 0,this._drums=void 0,this.useAlgorithmicPitch=!0,this.parseChannelData=function(t){return{voice:t.nextSignedShort(),instrument:t.nextByte(),pi:0!=t.nextByte(),noteCount:t.nextShort(),notes:[],loopNote:0}},this.parse=function(t){var n=new e(t),r=i._drums.map(function(t){return t.length});n.skip(6);var l,h,f=(l=n.nextShort(),h=i._sampleRate,function(t){return t*(Math.floor(h/1e3)*l)}),v=f(1);n.skip(2);for(var p=f(n.nextInt()),m=f(n.nextInt()),c=[],d=0;d<16;d++)c.push(i.parseChannelData(n));for(var g=0;g<16;g++){for(var x=95,w=1,P=254,y=6,S=0;S<c[g].noteCount;S++){var M=n.nextInt();c[g].notes.push({start:Math.floor(f(M)),end:0,leftVolume:0,rightVolume:0,pan:0,pitch:0,sampleAdvance:0,volume:0,length:0})}for(var B=0;B<c[g].noteCount;B++){var b=n.nextByte();255==b&&(b=x),x=b,c[g].notes[B].pitch=b}for(var A=0;A<c[g].noteCount;A++){var I=n.nextByte();255==I&&(I=w),w=I,c[g].notes[A].end=c[g].notes[A].start+f(I),c[g].notes[A].length=I}for(var _=0;_<c[g].noteCount;_++){var C=n.nextByte();255==C&&(C=P),P=C,c[g].notes[_].volume=C}for(var R=0;R<c[g].noteCount;R++){var D=n.nextByte();255==D&&(D=y),y=D,c[g].notes[R].pan=D}for(var V=0;V<c[g].noteCount;V++){var O=c[g].notes[V],W=O.pitch,E=g>=8,U=0;if(i.useAlgorithmicPitch)U=Math.pow(2,(W+c[g].voice/1e3+155.376)/12);else{var k=Math.floor(W%12),N=Math.floor(W/12);U=a[k]*s[N]+(c[g].voice-1e3)}var j=U/i._sampleRate,F=u(O.pan),q=F[0],z=F[1],G=Math.pow(10,8*(O.volume-255)/2e3);if(O.leftVolume=q*G,O.rightVolume=z*G,O.sampleAdvance=j,E){O.sampleAdvance=(800*O.pitch+100)/i._sampleRate,O.end=Math.floor(O.start+Math.min(r[c[g].instrument]/O.sampleAdvance,v*O.length/O.sampleAdvance));var H=c[g].notes[V+1];H&&(O.end=Math.floor(Math.min(O.end,H.start-1)))}if(c[g].pi){var J=Math.floor(W/12);O.end=O.start+4*(J+1)*o[J]}}c[g].notes.sort(function(t,e){return t.start-e.start});for(var K=0;K<c[g].noteCount;K++){var L=c[g].notes.findIndex(function(t){return t.end>p});c[g].loopNote=-1!=L?L:0}}return{startSamples:p,endSamples:m,channels:c,sampleRate:i._sampleRate,drums:i._drums,wavetable:i._wavetable,samplesPerBeat:f(1)}},this._sampleRate=t,this._wavetable=function(t){for(var n=[],r=new e(t),a=0;a<100;a++){var s=r.nextWavetable();n.push(s.map(function(t){return 1*t/256}))}return n}(n.WAVE100),this._drums=n.DRUMS.map(r)},h=function(t){try{return Promise.resolve(fetch(t)).then(function(t){return Promise.resolve(t.body.getReader().read()).then(function(t){return t.value})})}catch(t){return Promise.reject(t)}};exports.OrganyaPlayer=function(e,r,a){var s=this;this.waveData=void 0,this.sampleRate=void 0,this.song=void 0,this.stepBuffer=[0,0],this.channelBuffer=[0,0],this.sample=void 0,this.state=void 0,this.run=function(t,e,n){for(var r=[new Float32Array(t),new Float32Array(t)],a=0;a<t;a++)s.step(s.stepBuffer),e[a]=s.stepBuffer[0],n[a]=s.stepBuffer[1];return r},this.step=function(t){for(var e=0,r=0,a=0;a<16;a++)s.stepChannel(a,s.channelBuffer),e+=.3333333333333333*s.channelBuffer[0],r+=.3333333333333333*s.channelBuffer[1];if(s.sample++,s.sample>=s.song.endSamples){for(var o=0;o<16;o++)s.state[o]={noteIndex:s.song.channels[o].loopNote,wavetableOffset:0,samplesPlayed:0};s.sample=s.song.startSamples}var i,u=(i=s.sample)>1e3?1:i/1e3;t[0]=n(e)*u,t[1]=n(r)*u},this.stepChannel=function(e,n){var r=s.song.channels[e],a=s.state[e].noteIndex,o=e>=8,i=a>=r.notes.length?null:r.notes[a],u=0,l=0;if(null!=i&&s.sample>i.start){var h=r.instrument;if(!r.pi||s.state[e].samplesPlayed<1024){var f=s.state[e].wavetableOffset+i.sampleAdvance,v=s.getSample(o?s.song.drums[h]:s.song.wavetable[h],f);u=v*i.leftVolume,l=v*i.rightVolume,s.state[e].wavetableOffset=f,s.state[e].samplesPlayed++;var p=t(o,s.state[e].samplesPlayed)*function(e,n,r){return t(e,r-n)}(o,s.state[e].samplesPlayed,i.end-i.start)*(o?1:s.state[e].samplesPlayed>s.song.samplesPerBeat?.5:1);u*=p,l*=p}}null!=i&&s.sample>=i.end&&(s.state[e].wavetableOffset=0,s.state[e].samplesPlayed=0,s.state[e].noteIndex++),n[0]=u,n[1]=l},this.getSample=function(t,e){var n=t[Math.floor(e)%t.length],r=t[Math.ceil(e)%t.length];return n+(e-Math.floor(e))*(r-n)},this.waveData=r,this.sampleRate=a;var o=new l(a,r);this.song=o.parse(e),this.sample=-4e3,this.state=[];for(var i=0;i<16;i++)this.state.push({noteIndex:0,wavetableOffset:0,samplesPlayed:0})},exports.loadWavetableAndDrums=function(t){try{var e=t.endsWith("/")?"":"/",n=function(n){return t+e+n};return Promise.resolve(h(n("wave100.dat"))).then(function(t){return Promise.resolve(h(n("100.dat"))).then(function(e){return Promise.resolve(h(n("101.dat"))).then(function(r){return Promise.resolve(h(n("102.dat"))).then(function(a){return Promise.resolve(h(n("103.dat"))).then(function(s){return Promise.resolve(h(n("104.dat"))).then(function(o){return Promise.resolve(h(n("105.dat"))).then(function(i){return Promise.resolve(h(n("106.dat"))).then(function(u){return Promise.resolve(h(n("107.dat"))).then(function(l){return Promise.resolve(h(n("108.dat"))).then(function(f){return Promise.resolve(h(n("109.dat"))).then(function(v){return Promise.resolve(h(n("110.dat"))).then(function(p){return Promise.resolve(h(n("111.dat"))).then(function(n){return{WAVE100:t,DRUMS:[e,r,a,s,o,i,u,l,f,v,p,n]}})})})})})})})})})})})})})}catch(t){return Promise.reject(t)}};
//# sourceMappingURL=org-player.js.map
